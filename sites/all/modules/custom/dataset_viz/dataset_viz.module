<?php

// Show PHP errors (during development only)
    //error_reporting(E_ALL | E_STRICT);
    //ini_set("display_errors", 2);


/**
* Implements hook_menu().
*/
function dataset_viz_menu() {
  $items['dv-test'] = array(
    'title' => 'Data Vis Hello World Test',
    'description' => 'Test',
    'page callback' => 'dataset_viz_test',
    'access callback' => TRUE,
  );
  $items['dataset-viz'] = array(
    'title' => 'Dataset Visualization',
    'description' => 'Visually browse the Dataset Registry',
    'page callback' => 'dataset_viz_meta',
    'access callback' => TRUE,
  );

  return $items;
}

function dataset_viz_test() {
   return t("Hello World\n");
}

function dataset_viz_meta() {

    // Create a Mongo connection and connect to database //echo $db;
    $mongo = new MongoClient("mongodb://localhost");
    $db = $mongo->cats;


    // Select the main collection for dataset information
    $coll = $db->main;


    //$query = array(array('GeneSymbol' => 'RHEB'), array('FileName' => 1, 'GeneSymbol' => 1, 'logFC' => 1, 'PValue' => 1, 'adjPVal' => 1, 'B' => 1)); // SELECT title FROM fields_current WHERE group_name = 'node' AND type = 'content-type'

    //Build query and run it
    $query = array("GeneSymbol" => array('$in' => $gene_list));
		$cursor = $coll->find($query);
		$cursor->timeout(-1);
		$total = (string)$cursor->count(); //To find total number of documents

		//Access query results
		$result = array();
		$filenames = array();
		$i = 0;

		foreach ($cursor as $doc) {
			//var_dump($doc);
			$result[$i]['FileName'] = $doc['FileName'];
			$result[$i]['name'] = $doc['GeneSymbol'];
			$result[$i]['LogFC'] = $doc['logFC'];
			$result[$i]['PValue'] = $doc['PValue'];
			$result[$i]['AdjPVal'] = $doc['adjPVal'];
			$result[$i]['size'] = abs($doc['logFC']);
			$filenames[] = $doc['FileName'];
			$i++;
		}


		//var_dump($main_result);

		$chart = array(
    	'id' => 'visualization',
    	'type' => 'bubblechart',
    	'rows' => $result,
  	);

	return d3_draw($chart);
}




?>
